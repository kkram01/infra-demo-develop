name: Build and Deploy to Cloud Run

on:
  push:
    branches: [develop, main]
    paths:
      - 'service-yaml/container-dev.yaml'
      - 'service-yaml/container-qa.yaml'

jobs:
  
  check_changes:  # New job to check for file changes 
    outputs:
      dev: ${{steps.verify-changed-files.outputs.dev_any_changed}}
      qa: ${{steps.verify-changed-files.outputs.qa_any_changed}}
      other_count_dev: ${{ steps.verify-changed-files.outputs.dev_other_changed_files_count }}
      other_count_qa: ${{ steps.verify-changed-files.outputs.qa_other_changed_files_count }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Verify Changed files 
      
      uses: tj-actions/changed-files@v45
      id: verify-changed-files
      with:
        files_yaml: |
          dev: &dev
            - service-yaml/container-dev.yaml
          qa: &qa
            - service-yaml/container-qa.yaml
# skip this action since the other action will trigger a build 
    - name: Check if only changed
      uses: tj-actions/changed-files@v45
      id: verify-changed-files-count
      
    - name: Check Files count output
      run: echo "changed count $COUNT $OUTPUT"
      env:
        COUNT: ${{steps.verify-changed-files-count.outputs.all_changed_and_modified_files_count }}
        OUTPUT:  ${{fromJson(steps.verify-changed-files.outputs)}}
  test:
    needs: [check_changes]
    runs-on: ubuntu-latest
    steps:
      - env: 
          DEV: ${{needs.check_changes.outputs.dev}}
          QA: ${{needs.check_changes.outputs.qa}}
          CHANGED_COUNT: ${{needs.check_changes.outputs.other_count}}
        run: echo "$DEV $QA $CHANGED_COUNT"            

  # dev:
  #   needs: [check_changes]
  #   if: ${{ github.ref == 'refs/heads/develop' && needs.check_changes.outputs.dev == 'true' && needs.check_changes.outputs.other_count == '0' }}
    
  #   uses: ./.github/workflows/cloud-run-service-deployment.yml
  #   permissions:
  #     id-token: write
  #     contents: read
  #     actions: read
  #     security-events: write
  #     checks: write
  #     pull-requests: write
  #   with:
  #     environment: dev
  #   secrets: inherit

  # qa:
  #   needs: [check_changes]
  #   if: ${{ github.ref == 'refs/heads/main' && needs.check_changes.outputs.qa == 'true' && needs.check_changes.outputs.other_count == '0'  }}
  #   uses: ./.github/workflows/cloud-run-service-deployment.yml
  #   permissions:
  #     id-token: write
  #     contents: read
  #     actions: read
  #     security-events: write
  #     checks: write
  #     pull-requests: write
  #   with:
  #     environment: qa
  #   secrets: inherit
